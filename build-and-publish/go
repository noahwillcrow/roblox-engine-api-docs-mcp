#!/bin/bash

# A script to build and publish the Docker image for the Roblox Engine API Docs MCP Server.
#
# This script is a consolidation of the steps formerly found in `LOCAL_BUILD.md`.
# It provides a parameterized way to build and publish the Docker image to Docker Hub.
#
# Usage:
#   ./build-and-publish/go DOCKERHUB_USERNAME [DOCKERHUB_PASSWORD_OR_PAT] [--skip-ingestion]
#
# Arguments:
#   DOCKERHUB_USERNAME: Your Docker Hub username. (Required)
#   DOCKERHUB_PASSWORD_OR_PAT: Your Docker Hub password or Personal Access Token. (Optional)
#                            If not provided, you will be prompted to enter it.
#   --force-ingestion: (Optional) If provided, the script will remove any existing 'qdrant_data' directory
#                      and run the local ingestion script before building the main image.

set -eo pipefail

# --- Functions ---

# Function to print error messages and exit
#
# Globals:
#   None
# Arguments:
#   $1: The error message to print.
# Returns:
#   None
function error_exit() {
    echo "Error: $1" >&2
    exit 1
}

# Function to check for the presence of a command.
#
# Globals:
#   None
# Arguments:
#   $1: The command to check for.
# Returns:
#   None
function command_check() {
    if ! command -v "$1" &> /dev/null; then
        error_exit "$1 is not installed. Please install it to continue."
    fi
}

# --- Main Script ---

# Check for required commands
command_check "docker"

# Ensure a buildx builder is active
echo "--- Ensuring Docker Buildx builder is correctly configured ---"
# Create a new builder with a unique name and the docker-container driver
BUILDER_NAME="mcp-builder"
if ! docker buildx inspect "$BUILDER_NAME" &> /dev/null; then
    echo "--- Creating a new Docker Buildx builder: $BUILDER_NAME ---"
    docker buildx create --name "$BUILDER_NAME" --driver docker-container || error_exit "Failed to create Docker Buildx builder."
fi

# Use the custom builder
echo "--- Using Docker Buildx builder: $BUILDER_NAME ---"
docker buildx use "$BUILDER_NAME" || error_exit "Failed to use Docker Buildx builder."

# Set poetry command path
POETRY_CMD="poetry"
if ! command -v "poetry" &amp;> /dev/null; then
    echo "--- Poetry not found, installing... ---"
    if ! curl -sSL https://install.python-poetry.org | python -; then
        error_exit "Failed to install poetry."
    fi
    POETRY_CMD="$HOME/.local/bin/poetry"
fi

# Install dependencies for version script
echo "--- Installing script dependencies via Poetry ---"
if ! "$POETRY_CMD" install --only versioning; then
    error_exit "Failed to install dependencies with poetry."
fi

# Check for required arguments
if [ -z "$1" ]; then
    error_exit "Docker Hub username is required. Usage: ./build-and-publish/go DOCKERHUB_USERNAME [DOCKERHUB_PASSWORD_OR_PAT]"
fi

DOCKERHUB_USERNAME=""
DOCKERHUB_PASSWORD_OR_PAT=""
FORCE_INGESTION=false

for arg in "$@"; do
    case $arg in
        --force-ingestion)
            FORCE_INGESTION=true
            shift
            ;;
        *)
            if [ -z "$DOCKERHUB_USERNAME" ]; then
                DOCKERHUB_USERNAME="$arg"
            elif [ -z "$DOCKERHUB_PASSWORD_OR_PAT" ]; then
                DOCKERHUB_PASSWORD_OR_PAT="$arg"
            fi
            shift
            ;;
    esac
done

# Check for required arguments after parsing flags
if [ -z "$DOCKERHUB_USERNAME" ]; then
    error_exit "Docker Hub username is required. Usage: ./build-and-publish/go DOCKERHUB_USERNAME [DOCKERHUB_PASSWORD_OR_PAT] [--force-ingestion]"
fi

# Log in to Docker Hub
if [ -n "$DOCKERHUB_PASSWORD_OR_PAT" ]; then
    echo "$DOCKERHUB_PASSWORD_OR_PAT" | docker login --username "$DOCKERHUB_USERNAME" --password-stdin
else
    docker login --username "$DOCKERHUB_USERNAME"
fi

# Get the Roblox API Version
echo "--- Getting Roblox API Version ---"
VERSION=$("$POETRY_CMD" run python src/scripts/get_roblox_version.py)
if [ -z "$VERSION" ]; then
    error_exit "Failed to get Roblox API Version."
fi
echo "Roblox API Version: $VERSION"

if [ "$FORCE_INGESTION" = true ]; then
    echo "--- Force ingestion flag set, running local ingestion script ---"
    if [ -d "qdrant_data" ]; then
        echo "--- Removing existing qdrant_data directory ---"
        rm -rf "qdrant_data"
    fi
    ./build-and-publish/ingest-locally || error_exit "Local ingestion failed."
fi

# Check for the qdrant_data directory
if [ ! -d "qdrant_data" ]; then
    error_exit "'qdrant_data' directory not found. Please run './build-and-publish/ingest-locally' or use the --force-ingestion flag."
fi


# Build the MCP Server Docker Image for multiple platforms
echo "--- Building MCP Server Docker Image for multiple platforms ---"
# Build and push the Docker image for multiple platforms using buildx
# The --push flag automatically pushes the image to Docker Hub after building
docker buildx build \
    --platform linux/amd64,linux/arm64 \
    -t "$DOCKERHUB_USERNAME/roblox-engine-api-docs-mcp-server:latest" \
    -t "$DOCKERHUB_USERNAME/roblox-engine-api-docs-mcp-server:$VERSION" \
    --pull \
    --push .

echo "--- Docker image published successfully! ---"