#!/bin/bash

# A script to build and publish the Docker image for the Roblox Engine API Docs MCP Server.
#
# This script is a consolidation of the steps formerly found in `LOCAL_BUILD.md`.
# It provides a parameterized way to build and publish the Docker image to Docker Hub.
#
# Usage:
#   ./build-and-publish/go DOCKERHUB_USERNAME [DOCKERHUB_PASSWORD_OR_PAT] [--skip-ingestion]
#
# Arguments:
#   DOCKERHUB_USERNAME: Your Docker Hub username. (Required)
#   DOCKERHUB_PASSWORD_OR_PAT: Your Docker Hub password or Personal Access Token. (Optional)
#                            If not provided, you will be prompted to enter it.
#   --force-ingestion: (Optional) If provided, the script will remove any existing 'qdrant_data' directory
#                      and run the local ingestion script before building the main image.

set -eo pipefail

# Set OMP_NUM_THREADS to avoid PyTorch OpenMP memory allocation issues
export OMP_NUM_THREADS=1

# Fix Docker API version mismatch between client and daemon
# This can happen when the Docker client is newer than the Docker daemon
export DOCKER_API_VERSION=1.41

# --- Functions ---

# Function to print error messages and exit
#
# Globals:
#   None
# Arguments:
#   $1: The error message to print.
# Returns:
#   None
function error_exit() {
    echo "Error: $1" >&2
    exit 1
}

# Function to check for the presence of a command.
#
# Globals:
#   None
# Arguments:
#   $1: The command to check for.
# Returns:
#   None
function command_check() {
    if ! command -v "$1" > /dev/null 2>&1; then
        error_exit "$1 is not installed. Please install it to continue."
    fi
}

# --- Main Script ---

# Check for required commands
command_check "docker"

# Ensure a buildx builder is active
echo "--- Ensuring Docker Buildx builder is correctly configured ---"
# Use the default builder to avoid API version compatibility issues
# with older Docker daemons
BUILDER_NAME="default"
if ! docker buildx inspect "$BUILDER_NAME" > /dev/null 2>&1; then
    echo "--- Using default Docker Buildx builder ---"
    docker buildx use default || error_exit "Failed to use default Docker Buildx builder."
else
    echo "--- Using Docker Buildx builder: $BUILDER_NAME ---"
    docker buildx use "$BUILDER_NAME" || error_exit "Failed to use Docker Buildx builder."
fi

# Set poetry command path
POETRY_CMD="poetry"
if ! command -v "poetry" > /dev/null 2>&1; then
    echo "--- Poetry not found, attempting to install... ---"
    if ! curl -sSL https://install.python-poetry.org | python3 -; then
        error_exit "Failed to install poetry."
    fi
    # Add poetry to the path
    export PATH="$HOME/.local/bin:$PATH"
    POETRY_CMD="poetry" # It should now be in the path
fi

# Set up virtualenv
VENV_PATH=".venv"
PYTHON_CMD="$VENV_PATH/bin/python"

# Create virtualenv if it doesn't exist
if [ ! -d "$VENV_PATH" ]; then
    echo "--- Creating virtualenv ---"
    "$POETRY_CMD" install --only versioning || error_exit "Failed to create virtualenv with poetry."
else
    # Ensure dependencies are installed
    echo "--- Ensuring dependencies are installed ---"
    "$POETRY_CMD" install --only versioning || error_exit "Failed to install dependencies with poetry."
fi

# --- Argument Parsing ---
DOCKERHUB_USERNAME=""
DOCKERHUB_PASSWORD_OR_PAT=""
FORCE_INGESTION=false

# Parse arguments
while [[ "$#" -gt 0 ]]; do
    case $1 in
        --force-ingestion)
            FORCE_INGESTION=true
            shift
            ;;
        *)
            if [ -z "$DOCKERHUB_USERNAME" ]; then
                DOCKERHUB_USERNAME="$1"
            elif [ -z "$DOCKERHUB_PASSWORD_OR_PAT" ]; then
                DOCKERHUB_PASSWORD_OR_PAT="$1"
            fi
            shift
            ;;
    esac
done


# Check for required arguments
if [ -z "$DOCKERHUB_USERNAME" ]; then
    error_exit "Docker Hub username is required. Usage: ./build-and-publish/go DOCKERHUB_USERNAME [DOCKERHUB_PASSWORD_OR_PAT] [--force-ingestion]"
fi

# Log in to Docker Hub
if [ -n "$DOCKERHUB_PASSWORD_OR_PAT" ]; then
    echo "$DOCKERHUB_PASSWORD_OR_PAT" | docker login --username "$DOCKERHUB_USERNAME" --password-stdin
else
    docker login --username "$DOCKERHUB_USERNAME"
fi

# Get the Roblox API Version
echo "--- Getting Roblox API Version ---"
VERSION=$("$PYTHON_CMD" src/scripts/get_roblox_version.py)
if [ -z "$VERSION" ]; then
    error_exit "Failed to get Roblox API Version."
fi
echo "Roblox API Version: $VERSION"

if [ "$FORCE_INGESTION" = true ]; then
    echo "--- Force ingestion flag set, running local ingestion script ---"
    if [ -d "qdrant_data" ]; then
        echo "--- Removing existing qdrant_data directory ---"
        rm -rf "qdrant_data"
    fi
    env OMP_NUM_THREADS=1 ./build-and-publish/ingest-locally || error_exit "Local ingestion failed."
fi

# Check for the qdrant_data directory
if [ ! -d "qdrant_data" ]; then
    error_exit "'qdrant_data' directory not found. Please run './build-and-publish/ingest-locally' or use the --force-ingestion flag."
fi


# Build the MCP Server Docker Image
# Note: Using single-platform (linux/amd64) build for compatibility with most Docker setups
# Multi-platform builds require a buildx builder with the 'docker-container' driver
echo "--- Building MCP Server Docker Image for linux/amd64 ---"
docker buildx build \
    --platform linux/amd64 \
    -t "$DOCKERHUB_USERNAME/roblox-engine-api-docs-mcp-server:latest" \
    -t "$DOCKERHUB_USERNAME/roblox-engine-api-docs-mcp-server:$VERSION" \
    --pull \
    --file src/mcp_server/Dockerfile \
    --push .

echo "--- Docker image published successfully! ---"